# Bug Catalog for Test Validation Framework
# Defines bugs to inject for each integration test to validate test effectiveness
#
# Format:
#   - testId: Unique identifier from test file (file:line:column)
#   - testName: Human-readable test name
#   - functionality: What the test validates
#   - bugs: List of bugs to inject (each test should fail when bug is present)
#     - id: Unique bug identifier
#     - description: What this bug breaks
#     - targetFile: File to modify
#     - strategy: replace | delete | comment
#     - find: Exact string to find
#     - replace: String to replace with (for 'replace' strategy)
#     - expectedFailure: Hint about what assertion should fail

version: "1.0"
generated-at: "2025-11-23"

# ============================================================================
# Theme Toggle Tests (theme.spec.ts)
# ============================================================================

tests:
  - testId: "theme.spec.ts:25:3"
    testName: "should detect initial theme state on library page"
    testFile: "tests/integration/theme.spec.ts"
    functionality: "Verifies initial theme state is set and DOM class matches localStorage"
    bugs:
      - id: "theme-init-1"
        description: "Prevent initial theme from being set in localStorage"
        targetFile: "static/src/js/core.js"
        strategy: "comment"
        find: "localStorage.setItem('theme', theme);"
        expectedFailure: "expect(state.localStorage).not.toBeNull()"

      - id: "theme-init-2"
        description: "Break theme class application on page load"
        targetFile: "static/src/js/core.js"
        strategy: "replace"
        find: "document.body.classList.add(themeClass);"
        replace: "// BUG: Theme class not applied"
        expectedFailure: "expect(state.domClass).not.toBeNull()"

  - testId: "theme.spec.ts:45:3"
    testName: "should toggle theme on library page"
    testFile: "tests/integration/theme.spec.ts"
    functionality: "Toggles theme and verifies DOM class and localStorage are updated"
    bugs:
      - id: "theme-toggle-1"
        description: "Prevent theme class from being added to body"
        targetFile: "static/src/js/core.js"
        strategy: "comment"
        find: "document.body.classList.add('uk-dark');"
        expectedFailure: "expect(actualClass).toBe(expectedClass)"

      - id: "theme-toggle-2"
        description: "Prevent localStorage from being updated on toggle"
        targetFile: "static/src/js/core.js"
        strategy: "delete"
        find: "    localStorage.setItem('theme', theme);"
        expectedFailure: "expect(state.localStorage).toBe(expectedTheme)"

  - testId: "theme.spec.ts:79:3"
    testName: "should persist theme across page refresh"
    testFile: "tests/integration/theme.spec.ts"
    functionality: "Verifies theme persists in localStorage after page reload"
    bugs:
      - id: "theme-persist-1"
        description: "Don't read theme from localStorage on load"
        targetFile: "static/src/js/core.js"
        strategy: "replace"
        find: "function getTheme() {\n    return localStorage.getItem('theme') || detectSystemTheme();\n}"
        replace: "function getTheme() {\n    return detectSystemTheme(); // BUG: Ignore localStorage\n}"
        expectedFailure: "Theme should still be dark/light after reload"

      - id: "theme-persist-2"
        description: "Clear localStorage instead of setting theme"
        targetFile: "static/src/js/core.js"
        strategy: "replace"
        find: "localStorage.setItem('theme', theme);"
        replace: "localStorage.removeItem('theme'); // BUG: Clear instead of set"
        expectedFailure: "expect(darkState.localStorage).toBe('dark')"

  - testId: "theme.spec.ts:113:3"
    testName: "should maintain theme consistency across navigation"
    testFile: "tests/integration/theme.spec.ts"
    functionality: "Verifies theme persists when navigating between pages"
    bugs:
      - id: "theme-nav-1"
        description: "Reset theme to system default on each page load"
        targetFile: "static/src/js/core.js"
        strategy: "replace"
        find: "    applyTheme(getTheme());"
        replace: "    applyTheme(detectSystemTheme()); // BUG: Ignore saved theme"
        expectedFailure: "Theme should remain dark on library/tags pages"

  - testId: "theme.spec.ts:154:3"
    testName: "should toggle theme using navigation component"
    testFile: "tests/integration/theme.spec.ts"
    functionality: "Toggles theme via navigation component and verifies change"
    bugs:
      - id: "theme-nav-toggle-1"
        description: "Break theme toggle function"
        targetFile: "static/src/js/core.js"
        strategy: "replace"
        find: "function toggleTheme() {\n    const currentTheme = getTheme();\n    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';\n    applyTheme(newTheme);\n}"
        replace: "function toggleTheme() {\n    // BUG: Toggle does nothing\n    return;\n}"
        expectedFailure: "Theme should change when toggle clicked"

  - testId: "theme.spec.ts:177:3"
    testName: "should apply correct colors for light theme"
    testFile: "tests/integration/theme.spec.ts"
    functionality: "Verifies uk-light class is applied for light theme"
    bugs:
      - id: "theme-light-1"
        description: "Don't apply uk-light class"
        targetFile: "static/src/js/core.js"
        strategy: "replace"
        find: "    } else {\n        document.body.classList.add('uk-light');\n    }"
        replace: "    } else {\n        // BUG: uk-light class not applied\n    }"
        expectedFailure: "expect(bodyHasLightClass).toBe(true)"

  - testId: "theme.spec.ts:197:3"
    testName: "should apply correct colors for dark theme"
    testFile: "tests/integration/theme.spec.ts"
    functionality: "Verifies uk-dark class is applied for dark theme"
    bugs:
      - id: "theme-dark-1"
        description: "Don't apply uk-dark class"
        targetFile: "static/src/js/core.js"
        strategy: "comment"
        find: "        document.body.classList.add('uk-dark');"
        expectedFailure: "expect(bodyHasDarkClass).toBe(true)"

  - testId: "theme.spec.ts:217:3"
    testName: "should work on home page"
    testFile: "tests/integration/theme.spec.ts"
    functionality: "Verifies theme toggle works on home page"
    bugs:
      - id: "theme-home-1"
        description: "Break toggleTheme function completely"
        targetFile: "static/src/js/core.js"
        strategy: "replace"
        find: "function toggleTheme() {\n    const currentTheme = getTheme();\n    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';\n    applyTheme(newTheme);\n}"
        replace: "function toggleTheme() {\n    return; // BUG: Disabled\n}"
        expectedFailure: "Theme should toggle on home page"

  - testId: "theme.spec.ts:232:3"
    testName: "should prevent theme class conflicts"
    testFile: "tests/integration/theme.spec.ts"
    functionality: "Verifies only one theme class (uk-dark OR uk-light) is active at a time"
    bugs:
      - id: "theme-conflict-1"
        description: "Don't remove old theme class before adding new one"
        targetFile: "static/src/js/core.js"
        strategy: "comment"
        find: "    document.body.classList.remove('uk-dark', 'uk-light');"
        expectedFailure: "verifyMutualExclusion should fail - both classes present"

      - id: "theme-conflict-2"
        description: "Add both theme classes at once"
        targetFile: "static/src/js/core.js"
        strategy: "replace"
        find: "    // Apply the correct theme class\n    if (theme === 'dark') {\n        document.body.classList.add('uk-dark');\n    } else {\n        document.body.classList.add('uk-light');\n    }"
        replace: "    // BUG: Add both classes\n    document.body.classList.add('uk-dark', 'uk-light');"
        expectedFailure: "verifyMutualExclusion should detect both classes active"

# ============================================================================
# Reader Tests (reader.spec.ts, reader-theme.spec.ts)
# ============================================================================

  - testId: "reader.spec.ts:39:3"
    testName: "should load reader without JavaScript errors"
    testFile: "tests/integration/reader.spec.ts"
    functionality: "Verifies reader loads without JavaScript errors in console"
    bugs:
      - id: "reader-jserror-1"
        description: "Introduce JavaScript syntax error in reader.js"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "function loadPreferences() {"
        replace: "function loadPreferences( {  // BUG: Syntax error"
        expectedFailure: "Console error detection should catch syntax error"

      - id: "reader-jserror-2"
        description: "Reference undefined variable"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "const pagedImage = document.getElementById('paged-image');"
        replace: "const pagedImage = undefinedVariable; // BUG: undefined variable"
        expectedFailure: "Console should show 'undefinedVariable is not defined'"

  - testId: "reader.spec.ts:75:3"
    testName: "should navigate pages in paged mode with click"
    testFile: "tests/integration/reader.spec.ts"
    functionality: "Verifies clicking right area navigates to next page"
    bugs:
      - id: "reader-click-nav-1"
        description: "Disable right-click navigation"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "function handleRightClick() {\n    if (enableRTL) {\n        previousPage();\n    } else {\n        nextPage();\n    }\n}"
        replace: "function handleRightClick() {\n    // BUG: Navigation disabled\n    return;\n}"
        expectedFailure: "Current page should change after clicking right area"

      - id: "reader-click-nav-2"
        description: "Break nextPage function"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "function nextPage() {\n    if (currentPage < TOTAL_PAGES) {\n        loadPage(currentPage + 1);"
        replace: "function nextPage() {\n    // BUG: nextPage does nothing\n    return;\n    if (currentPage < TOTAL_PAGES) {\n        loadPage(currentPage + 1);"
        expectedFailure: "expect(await reader.getCurrentPage()).toBe(2)"

  - testId: "reader.spec.ts:101:3"
    testName: "should navigate pages with keyboard"
    testFile: "tests/integration/reader.spec.ts"
    functionality: "Verifies arrow key navigation works"
    bugs:
      - id: "reader-keyboard-1"
        description: "Disable arrow key event listener"
        targetFile: "templates/reader.js"
        strategy: "comment"
        find: "document.addEventListener('keydown', function(e) {"
        expectedFailure: "Keyboard navigation should change page number"

      - id: "reader-keyboard-2"
        description: "Prevent handleRightClick from being called"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "        case 'ArrowRight':\n            e.preventDefault();\n            handleRightClick();\n            break;"
        replace: "        case 'ArrowRight':\n            e.preventDefault();\n            // BUG: Handler not called\n            break;"
        expectedFailure: "ArrowRight should navigate to next page"

  - testId: "reader.spec.ts:133:3"
    testName: "should load all images in continuous mode"
    testFile: "tests/integration/reader.spec.ts"
    functionality: "Verifies continuous mode loads all page images"
    bugs:
      - id: "reader-continuous-1"
        description: "Break image creation loop in continuous mode"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "    for (let page = 1; page <= TOTAL_PAGES; page++) {"
        replace: "    for (let page = 1; page <= 2; page++) { // BUG: Only load 2 images"
        expectedFailure: "Should load at least 5 images but only loads 2"

      - id: "reader-continuous-2"
        description: "Prevent image src from being set"
        targetFile: "templates/reader.js"
        strategy: "comment"
        find: "        img.src = getPageUrl(page);"
        expectedFailure: "Images won't load without src attribute"

  - testId: "reader.spec.ts:171:3"
    testName: "should switch between paged and continuous modes"
    testFile: "tests/integration/reader.spec.ts"
    functionality: "Verifies mode switching updates body class and initializes mode"
    bugs:
      - id: "reader-mode-switch-1"
        description: "Prevent mode variable from being updated"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "function changeMode() {\n    mode = modeSelect.value;"
        replace: "function changeMode() {\n    // BUG: mode not updated\n    // mode = modeSelect.value;"
        expectedFailure: "Mode should change but stays as paged/continuous"

      - id: "reader-mode-switch-2"
        description: "Don't apply body class for continuous mode"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "    document.body.className = mode === 'continuous' ? 'continuous-mode' : `paged-mode fit-${fit}`;"
        replace: "    // BUG: body class not applied"
        expectedFailure: "isContinuousMode check should fail (checks body class)"

  - testId: "reader.spec.ts:199:3"
    testName: "should open and interact with settings modal"
    testFile: "tests/integration/reader.spec.ts"
    functionality: "Verifies settings modal opens when button clicked"
    bugs:
      - id: "reader-settings-modal-1"
        description: "Prevent settings modal from opening with keyboard shortcut"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "        case 's':\n        case 'S':\n            e.preventDefault();\n            UIkit.modal('#settings-modal').show();\n            break;"
        replace: "        case 's':\n        case 'S':\n            e.preventDefault();\n            // BUG: Modal not opened\n            break;"
        expectedFailure: "Settings modal should be visible after pressing 's'"

  - testId: "reader.spec.ts:218:3"
    testName: "should change fit options in paged mode"
    testFile: "tests/integration/reader.spec.ts"
    functionality: "Verifies fit option changes update body class"
    bugs:
      - id: "reader-fit-1"
        description: "Prevent fit variable from being updated"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "function changeFit() {\n    fit = fitSelect.value;"
        replace: "function changeFit() {\n    // BUG: fit not updated\n    // fit = fitSelect.value;"
        expectedFailure: "Body class should change to reflect fit option"

      - id: "reader-fit-2"
        description: "Don't apply body class with fit"
        targetFile: "templates/reader.js"
        strategy: "comment"
        find: "    document.body.className = `paged-mode fit-${fit}`;"
        expectedFailure: "Body class won't update to new fit option"

  - testId: "reader.spec.ts:244:3"
    testName: "should jump to specific page"
    testFile: "tests/integration/reader.spec.ts"
    functionality: "Verifies page select dropdown allows jumping to specific page"
    bugs:
      - id: "reader-jump-1"
        description: "Disable jumpToPage function"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "function jumpToPage() {\n    const page = parseInt(pageSelect.value);"
        replace: "function jumpToPage() {\n    return; // BUG: Jump disabled\n    const page = parseInt(pageSelect.value);"
        expectedFailure: "Current page should change to 3 but stays at 1"

      - id: "reader-jump-2"
        description: "Break loadPage call in jumpToPage"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "    if (mode === 'paged') {\n        loadPage(page);"
        replace: "    if (mode === 'paged') {\n        // BUG: loadPage not called"
        expectedFailure: "Page should jump to selected page"

  - testId: "reader.spec.ts:273:3"
    testName: "should persist reader settings in localStorage"
    testFile: "tests/integration/reader.spec.ts"
    functionality: "Verifies reader settings are saved to localStorage and persist across reload"
    bugs:
      - id: "reader-persist-1"
        description: "Prevent localStorage from being written"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "function savePreferences() {\n    localStorage.setItem('reader-mode', mode);"
        replace: "function savePreferences() {\n    // BUG: localStorage not saved\n    return;\n    localStorage.setItem('reader-mode', mode);"
        expectedFailure: "localStorage should contain 'reader-mode' but is null"

      - id: "reader-persist-2"
        description: "Don't load preferences from localStorage"
        targetFile: "templates/reader.js"
        strategy: "replace"
        find: "    const savedMode = localStorage.getItem('reader-mode');"
        replace: "    const savedMode = null; // BUG: Don't read from localStorage"
        expectedFailure: "Mode should be 'continuous' after reload but is 'paged'"

  - testId: "reader.spec.ts:297:3"
    testName: "should verify reader page respects theme on load"
    testFile: "tests/integration/reader.spec.ts"
    functionality: "Verifies settings button is visible and functional"
    bugs:
      - id: "reader-theme-btn-1"
        description: "Hide settings button"
        targetFile: "templates/reader.html"
        strategy: "replace"
        find: "<button id=\"settings-btn\" onclick=\"UIkit.modal('#settings-modal').show()\">⚙️</button>"
        replace: "<button id=\"settings-btn\" onclick=\"UIkit.modal('#settings-modal').show()\" style=\"display: none;\">⚙️</button> <!-- BUG: Hidden -->"
        expectedFailure: "Settings button should be visible"

  # Reader Theme Tests (reader-theme.spec.ts)

  - testId: "reader-theme.spec.ts:29:3"
    testName: "should load reader with light theme when light theme is set"
    testFile: "tests/integration/reader-theme.spec.ts"
    functionality: "Verifies reader page loads with light theme from localStorage"
    bugs:
      - id: "reader-theme-light-1"
        description: "Ignore theme localStorage on reader page"
        targetFile: "static/src/js/core.js"
        strategy: "replace"
        find: "function getTheme() {\n    return localStorage.getItem('theme') || detectSystemTheme();\n}"
        replace: "function getTheme() {\n    return detectSystemTheme(); // BUG: Ignore saved theme\n}"
        expectedFailure: "localStorage should be 'light' but theme reverts to system"

  - testId: "reader-theme.spec.ts:52:3"
    testName: "should load reader with dark theme when dark theme is set"
    testFile: "tests/integration/reader-theme.spec.ts"
    functionality: "Verifies reader page loads with dark theme from localStorage"
    bugs:
      - id: "reader-theme-dark-1"
        description: "Clear theme localStorage on page load"
        targetFile: "static/src/js/core.js"
        strategy: "replace"
        find: "document.addEventListener('DOMContentLoaded', () => {\n    // Apply theme on page load\n    applyTheme(getTheme());"
        replace: "document.addEventListener('DOMContentLoaded', () => {\n    // BUG: Clear theme\n    localStorage.removeItem('theme');\n    // Apply theme on page load\n    applyTheme(getTheme());"
        expectedFailure: "localStorage should be 'dark' but is cleared"

  - testId: "reader-theme.spec.ts:75:3"
    testName: "should have settings button visible in both themes"
    testFile: "tests/integration/reader-theme.spec.ts"
    functionality: "Verifies settings button works in both light and dark themes"
    bugs:
      - id: "reader-theme-btn-both-1"
        description: "Break settings button click handler"
        targetFile: "templates/reader.html"
        strategy: "replace"
        find: "<button id=\"settings-btn\" onclick=\"UIkit.modal('#settings-modal').show()\">⚙️</button>"
        replace: "<button id=\"settings-btn\">⚙️</button> <!-- BUG: onclick removed -->"
        expectedFailure: "Settings modal should open when button clicked"

  - testId: "reader-theme.spec.ts:116:3"
    testName: "should preserve theme preference across reader sessions"
    testFile: "tests/integration/reader-theme.spec.ts"
    functionality: "Verifies theme persists when navigating to/from reader multiple times"
    bugs:
      - id: "reader-theme-persist-1"
        description: "Clear localStorage on every page load"
        targetFile: "static/src/js/core.js"
        strategy: "replace"
        find: "document.addEventListener('DOMContentLoaded', () => {\n    // Apply theme on page load\n    applyTheme(getTheme());"
        replace: "document.addEventListener('DOMContentLoaded', () => {\n    localStorage.clear(); // BUG: Clear all storage\n    // Apply theme on page load\n    applyTheme(getTheme());"
        expectedFailure: "Theme should persist as 'dark' but is cleared"

  - testId: "reader-theme.spec.ts:148:3"
    testName: "should have visible and functional settings button"
    testFile: "tests/integration/reader-theme.spec.ts"
    functionality: "Verifies settings button is always visible and opens modal"
    bugs:
      - id: "reader-settings-visible-1"
        description: "Make settings button invisible"
        targetFile: "templates/reader.html"
        strategy: "replace"
        find: "<button id=\"settings-btn\" onclick=\"UIkit.modal('#settings-modal').show()\">⚙️</button>"
        replace: "<button id=\"settings-btn\" onclick=\"UIkit.modal('#settings-modal').show()\" style=\"visibility: hidden;\">⚙️</button> <!-- BUG: Invisible -->"
        expectedFailure: "Settings button should be visible"

# ============================================================================
# Library Tests (library.spec.ts)
# ============================================================================

  - testId: "library.spec.ts:12:3"
    testName: "should load library page with titles"
    testFile: "tests/integration/library.spec.ts"
    functionality: "Verifies library page loads and displays title count"
    bugs:
      - id: "library-load-1"
        description: "Break Alpine.js initialization"
        targetFile: "static/js/library.js"
        strategy: "replace"
        find: "function libraryData() {"
        replace: "function libraryData( {  // BUG: Syntax error"
        expectedFailure: "Alpine.js component won't initialize, page errors"

  - testId: "library.spec.ts:30:3"
    testName: "should display title cards with correct structure"
    testFile: "tests/integration/library.spec.ts"
    functionality: "Verifies title cards have proper HTML structure with thumbnails and titles"
    bugs:
      - id: "library-structure-1"
        description: "Hide title cards"
        targetFile: "templates/library.html"
        strategy: "replace"
        find: "        <a href=\"/book/{{ title.id }}\" class=\"title-card\"\n           x-show=\"matchesSearch('{{ title.name }}')\">"
        replace: "        <a href=\"/book/{{ title.id }}\" class=\"title-card\" style=\"display: none;\"\n           x-show=\"matchesSearch('{{ title.name }}')\">"
        expectedFailure: "Title cards not visible"

  - testId: "library.spec.ts:57:3"
    testName: "should search and filter titles"
    testFile: "tests/integration/library.spec.ts"
    functionality: "Verifies search input filters title cards based on query"
    bugs:
      - id: "library-search-1"
        description: "Break matchesSearch function"
        targetFile: "static/js/library.js"
        strategy: "replace"
        find: "        matchesSearch(titleName) {\n            if (!this.searchQuery.trim()) {\n                return true;\n            }\n            const regex = new RegExp(this.searchQuery, 'i');\n            return regex.test(titleName);\n        },"
        replace: "        matchesSearch(titleName) {\n            return true; // BUG: Always show all\n        },"
        expectedFailure: "Filtered count should be less than initial but stays same"

      - id: "library-search-2"
        description: "Prevent regex test from working"
        targetFile: "static/js/library.js"
        strategy: "replace"
        find: "return regex.test(titleName);"
        replace: "return true; // BUG: Search doesn't filter"
        expectedFailure: "Search doesn't filter title cards"

  - testId: "library.spec.ts:93:3"
    testName: "should clear search and show all titles"
    testFile: "tests/integration/library.spec.ts"
    functionality: "Verifies clearing search input shows all titles again"
    bugs:
      - id: "library-clear-1"
        description: "Don't check for empty search query"
        targetFile: "static/js/library.js"
        strategy: "replace"
        find: "if (!this.searchQuery.trim()) {\n                return true;\n            }"
        replace: "// BUG: Don't show all when search is empty"
        expectedFailure: "Cleared count should equal initial but doesn't"

  - testId: "library.spec.ts:117:3"
    testName: "should search case-insensitively"
    testFile: "tests/integration/library.spec.ts"
    functionality: "Verifies search works regardless of case"
    bugs:
      - id: "library-case-1"
        description: "Make search case-sensitive"
        targetFile: "static/js/library.js"
        strategy: "replace"
        find: "const regex = new RegExp(this.searchQuery, 'i');"
        replace: "const regex = new RegExp(this.searchQuery); // BUG: case-sensitive"
        expectedFailure: "Uppercase and lowercase searches have different results"

  - testId: "library.spec.ts:153:3"
    testName: "should sort by name"
    testFile: "tests/integration/library.spec.ts"
    functionality: "Verifies sort by name orders titles alphabetically"
    bugs:
      - id: "library-sort-name-1"
        description: "Break sort parameter handling"
        targetFile: "src/library/manager.rs"
        strategy: "replace"
        find: "            SortMethod::Name | SortMethod::Progress | SortMethod::Auto => {\n                // Progress sorting is handled at route level (after calculating progress with username context)\n                // Auto uses name sorting (future: smart chapter detection)\n                sort_by_name(&mut titles, ascending);\n            }"
        replace: "            SortMethod::Name | SortMethod::Progress | SortMethod::Auto => {\n                // BUG: Don't sort by name\n            }"
        expectedFailure: "Titles not sorted alphabetically"

  - testId: "library.spec.ts:178:3"
    testName: "should sort by date"
    testFile: "tests/integration/library.spec.ts"
    functionality: "Verifies sort by date changes title order"
    bugs:
      - id: "library-sort-date-1"
        description: "Break date sorting"
        targetFile: "src/library/manager.rs"
        strategy: "replace"
        find: "            SortMethod::TimeModified => {\n                sort_by_mtime(&mut titles, ascending);\n            }"
        replace: "            SortMethod::TimeModified => {\n                // BUG: Don't sort by mtime\n            }"
        expectedFailure: "Title count should match but order isn't by date"

  - testId: "library.spec.ts:202:3"
    testName: "should sort by progress"
    testFile: "tests/integration/library.spec.ts"
    functionality: "Verifies sort by progress reorders titles"
    bugs:
      - id: "library-sort-progress-1"
        description: "Break progress sorting"
        targetFile: "src/routes/main.rs"
        strategy: "replace"
        find: "    // Sort by progress if requested (after calculating progress)\n    if matches!(sort_method, SortMethod::Progress) {\n        sort_by_progress(&mut titles, ascending);\n    }"
        replace: "    // Sort by progress if requested (after calculating progress)\n    if matches!(sort_method, SortMethod::Progress) {\n        // BUG: Don't sort by progress\n    }"
        expectedFailure: "Titles not ordered by progress"

  - testId: "library.spec.ts:226:3"
    testName: "should maintain search filter when changing sort"
    testFile: "tests/integration/library.spec.ts"
    functionality: "Verifies search works after changing sort (tests search functionality persists)"
    bugs:
      - id: "library-search-after-sort-1"
        description: "Break URL param handling in sort"
        targetFile: "static/js/library.js"
        strategy: "replace"
        find: "url.searchParams.set('sort', sort);"
        replace: "// BUG: sort param not set"
        expectedFailure: "Sort dropdown won't update URL correctly"

  - testId: "library.spec.ts:268:3"
    testName: "should click on title card and navigate to book page"
    testFile: "tests/integration/library.spec.ts"
    functionality: "Verifies clicking title card navigates to book detail page"
    bugs:
      - id: "library-nav-1"
        description: "Remove href from title cards"
        targetFile: "templates/library.html"
        strategy: "replace"
        find: "<a href=\"/book/{{ title.id }}\""
        replace: "<a <!-- BUG: No href -->"
        expectedFailure: "URL should change but doesn't navigate"

  - testId: "library.spec.ts:299:3"
    testName: "should show empty state with no results"
    testFile: "tests/integration/library.spec.ts"
    functionality: "Verifies no title cards shown when search has no matches"
    bugs:
      - id: "library-empty-1"
        description: "Always show all cards even when search doesn't match"
        targetFile: "static/js/library.js"
        strategy: "replace"
        find: "matchesSearch(titleName) {\n            if (!this.searchQuery.trim()) {\n                return true;\n            }\n            const regex = new RegExp(this.searchQuery, 'i');\n            return regex.test(titleName);\n        }"
        replace: "matchesSearch(titleName) {\n            return true; // BUG: Always show\n        }"
        expectedFailure: "Count should be 0 but all cards visible"

  - testId: "library.spec.ts:323:3"
    testName: "should have working navigation while on library page"
    testFile: "tests/integration/library.spec.ts"
    functionality: "Verifies navigation links work from library page"
    bugs:
      - id: "library-page-nav-1"
        description: "Break navigation link to tags"
        targetFile: "templates/base.html"
        strategy: "replace"
        find: "<a class=\"nav-item\" href=\"/tags\">TAGS</a>"
        replace: "<a class=\"nav-item\" href=\"#\">TAGS</a> <!-- BUG: broken link -->"
        expectedFailure: "URL should contain /tags but doesn't"

# ============================================================================
# Navigation Tests (navigation.spec.ts)
# ============================================================================

  - testId: "navigation.spec.ts:12:3"
    testName: "should navigate to Library page"
    testFile: "tests/integration/navigation.spec.ts"
    functionality: "Verifies clicking Library link navigates to /library"
    bugs:
      - id: "nav-library-1"
        description: "Break library navigation link"
        targetFile: "templates/base.html"
        strategy: "replace"
        find: "<a class=\"nav-item\" href=\"/library\">LIBRARY</a>"
        replace: "<a class=\"nav-item\" href=\"/broken\">LIBRARY</a> <!-- BUG -->"
        expectedFailure: "URL should contain /library but goes to /broken"

  - testId: "navigation.spec.ts:30:3"
    testName: "should navigate to Tags page"
    testFile: "tests/integration/navigation.spec.ts"
    functionality: "Verifies clicking Tags link navigates to /tags"
    bugs:
      - id: "nav-tags-1"
        description: "Break tags navigation link"
        targetFile: "templates/base.html"
        strategy: "replace"
        find: "<li{% if tags_active %} class=\"uk-active\"{% endif %}><a class=\"nav-item\" href=\"/tags\">TAGS</a></li>"
        replace: "<li{% if tags_active %} class=\"uk-active\"{% endif %}><a class=\"nav-item\">TAGS</a></li> <!-- BUG: no href -->"
        expectedFailure: "URL should contain /tags but doesn't navigate"

  - testId: "navigation.spec.ts:47:3"
    testName: "should highlight active navigation link on Library page"
    testFile: "tests/integration/navigation.spec.ts"
    functionality: "Verifies library link has uk-active class on library page"
    bugs:
      - id: "nav-active-library-1"
        description: "Don't apply active class to library link"
        targetFile: "templates/base.html"
        strategy: "replace"
        find: "<li{% if library_active %} class=\"uk-active\"{% endif %}><a class=\"nav-item\" href=\"/library\">LIBRARY</a></li>"
        replace: "<li><a class=\"nav-item\" href=\"/library\">LIBRARY</a></li> <!-- BUG: No active class -->"
        expectedFailure: "Library link should be active but isn't"

  - testId: "navigation.spec.ts:59:3"
    testName: "should highlight active navigation link on Tags page"
    testFile: "tests/integration/navigation.spec.ts"
    functionality: "Verifies tags link has uk-active class on tags page"
    bugs:
      - id: "nav-active-tags-1"
        description: "Don't apply active class to tags link"
        targetFile: "templates/base.html"
        strategy: "replace"
        find: "<li{% if tags_active %} class=\"uk-active\"{% endif %}><a class=\"nav-item\" href=\"/tags\">TAGS</a></li>"
        replace: "<li><a class=\"nav-item\" href=\"/tags\">TAGS</a></li> <!-- BUG: No active class -->"
        expectedFailure: "Tags link should be active but isn't"

  - testId: "navigation.spec.ts:71:3"
    testName: "should update active link when navigating between pages"
    testFile: "tests/integration/navigation.spec.ts"
    functionality: "Verifies active class moves when navigating between pages"
    bugs:
      - id: "nav-active-update-1"
        description: "Make all links always active"
        targetFile: "templates/base.html"
        strategy: "replace"
        find: "<li{% if library_active %} class=\"uk-active\"{% endif %}><a class=\"nav-item\" href=\"/library\">LIBRARY</a></li>"
        replace: "<li class=\"uk-active\"><a class=\"nav-item\" href=\"/library\">LIBRARY</a></li> <!-- BUG: Always active -->"
        expectedFailure: "Library should not be active on tags page"

  - testId: "navigation.spec.ts:94:3"
    testName: "should display all navigation links"
    testFile: "tests/integration/navigation.spec.ts"
    functionality: "Verifies all navigation elements are visible on desktop"
    bugs:
      - id: "nav-display-1"
        description: "Hide desktop navigation"
        targetFile: "templates/base.html"
        strategy: "replace"
        find: "<div class=\"uk-navbar-left uk-visible@m uk-margin-left\">"
        replace: "<div class=\"uk-navbar-left uk-visible@m uk-margin-left\" style=\"display: none;\"> <!-- BUG: Hidden -->"
        expectedFailure: "Desktop navigation should be visible but is hidden"

  - testId: "navigation.spec.ts:115:3"
    testName: "should open mobile hamburger menu"
    testFile: "tests/integration/navigation.spec.ts"
    functionality: "Verifies mobile menu opens when hamburger button clicked"
    bugs:
      - id: "nav-mobile-open-1"
        description: "Break uk-toggle attribute"
        targetFile: "templates/base.html"
        strategy: "replace"
        find: "uk-toggle=\"target: #mobile-nav\""
        replace: "<!-- BUG: uk-toggle removed -->"
        expectedFailure: "Mobile menu should be visible but doesn't open"

  - testId: "navigation.spec.ts:140:3"
    testName: "should navigate using mobile menu"
    testFile: "tests/integration/navigation.spec.ts"
    functionality: "Verifies navigation links work inside mobile offcanvas menu"
    bugs:
      - id: "nav-mobile-links-1"
        description: "Remove href from mobile library link"
        targetFile: "templates/base.html"
        strategy: "replace"
        find: "<li{% if library_active %} class=\"uk-active\"{% endif %}><a href=\"/library\">Library</a></li>"
        replace: "<li{% if library_active %} class=\"uk-active\"{% endif %}><a>Library</a></li> <!-- BUG: No href -->"
        expectedFailure: "URL should contain /library from mobile menu"

  - testId: "navigation.spec.ts:163:3"
    testName: "should close mobile menu with escape key"
    testFile: "tests/integration/navigation.spec.ts"
    functionality: "Verifies pressing Escape closes mobile menu"
    bugs:
      - id: "nav-mobile-close-1"
        description: "Break offcanvas close functionality"
        targetFile: "templates/base.html"
        strategy: "replace"
        find: "<button class=\"uk-offcanvas-close\" type=\"button\" uk-close></button>"
        replace: "<button class=\"uk-offcanvas-close\" type=\"button\"></button> <!-- BUG: No uk-close -->"
        expectedFailure: "Mobile menu should close but stays visible"

  - testId: "navigation.spec.ts:186:3"
    testName: "should display navigation on all pages"
    testFile: "tests/integration/navigation.spec.ts"
    functionality: "Verifies navbar is present on home, library, and tags pages"
    bugs:
      - id: "nav-all-pages-1"
        description: "Hide navbar container"
        targetFile: "templates/base.html"
        strategy: "replace"
        find: "<div class=\"uk-navbar-container\" uk-navbar>"
        replace: "<div class=\"uk-navbar-container\" uk-navbar style=\"display: none;\"> <!-- BUG: Hidden -->"
        expectedFailure: "Navbar should be visible on all pages"

  - testId: "navigation.spec.ts:204:3"
    testName: "should maintain navigation state during page transitions"
    testFile: "tests/integration/navigation.spec.ts"
    functionality: "Verifies navigation persists when navigating from library to book and back"
    bugs:
      - id: "nav-state-1"
        description: "Break navigation on book page"
        targetFile: "templates/book.html"
        strategy: "replace"
        find: "{% extends \"base.html\" %}"
        replace: "<!-- BUG: Don't extend base -->"
        expectedFailure: "Navbar should be visible on book page"

  - testId: "navigation.spec.ts:231:3"
    testName: "should work with both desktop and mobile viewports"
    testFile: "tests/integration/navigation.spec.ts"
    functionality: "Verifies responsive navigation works in desktop and mobile viewports"
    bugs:
      - id: "nav-responsive-1"
        description: "Break responsive visibility classes"
        targetFile: "templates/base.html"
        strategy: "replace"
        find: "<div class=\"uk-navbar-left uk-visible@m uk-margin-left\">"
        replace: "<div class=\"uk-navbar-left uk-margin-left\"> <!-- BUG: Always show desktop -->"
        expectedFailure: "Desktop nav visible in mobile, hamburger not shown"
