{% extends "base.html" %}

{% block title %}{{ title_name }} - Book{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/book.css">
{% endblock %}

{% block content %}
<div x-data="bookData()">
    <!-- Header Section -->
    <div class="title-header">
        <h2>{{ title_name }}</h2>
        <nav class="breadcrumb">
            <a href="/library">Library</a> / {{ title_name }}
        </nav>
    </div>

    <p class="subtitle">{{ entry_count }} {% if entry_count == 1 %}entry{% else %}entries{% endif %} found</p>

    <!-- Tags Section -->
    {% if is_admin %}
    <div class="uk-margin" x-data="tagsData()" data-title-id="{{ title_id }}">
        <h4 class="uk-margin-small-bottom">Tags</h4>
        <div class="uk-margin-small-bottom">
            <template x-for="tag in tags" :key="tag">
                <span class="uk-label uk-label-primary uk-margin-small-right uk-margin-small-bottom"
                      style="padding:5px 10px; text-transform:none; display:inline-block;">
                    <span x-text="tag"></span>
                    <button @click="deleteTag(tag)"
                            class="uk-close-small uk-margin-small-left"
                            type="button"
                            style="color:white; opacity:0.7;"
                            :disabled="deletingTag === tag">×</button>
                </span>
            </template>
            <span x-show="tags.length === 0" class="uk-text-muted">No tags</span>
        </div>
        <div class="uk-flex uk-flex-middle" x-show="showAddForm" style="position:relative;">
            <div style="position:relative; width:300px;">
                <input type="text"
                       class="uk-input uk-form-small"
                       placeholder="Enter tag name"
                       x-model="newTag"
                       @input="showSuggestions = true"
                       @keydown.enter="addTag()"
                       @keydown.escape="cancelAdd()"
                       @focus="showSuggestions = true"
                       @blur="setTimeout(() => showSuggestions = false, 200)">
                <div x-show="showSuggestions && filteredSuggestions.length > 0"
                     style="position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #e5e5e5; border-radius:4px; max-height:200px; overflow-y:auto; z-index:100; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <template x-for="suggestion in filteredSuggestions.slice(0, 10)" :key="suggestion">
                        <div @click="selectSuggestion(suggestion)"
                             style="padding:8px 12px; cursor:pointer; border-bottom:1px solid #f5f5f5;"
                             @mouseenter="$el.style.background='#f5f5f5'"
                             @mouseleave="$el.style.background='white'"
                             x-text="suggestion"></div>
                    </template>
                </div>
            </div>
            <button class="uk-button uk-button-primary uk-button-small uk-margin-small-left"
                    @click="addTag()"
                    :disabled="!newTag.trim() || addingTag">Add</button>
            <button class="uk-button uk-button-default uk-button-small uk-margin-small-left"
                    @click="cancelAdd()">Cancel</button>
        </div>
        <button x-show="!showAddForm"
                class="uk-button uk-button-default uk-button-small"
                @click="showAddForm = true">+ Add Tag</button>
    </div>
    {% endif %}

    <!-- Search and Sort Controls -->
    <div class="uk-grid-small" uk-grid>
        <div class="uk-margin-bottom uk-width-3-4@s">
            <form class="uk-search uk-search-default">
                <span uk-search-icon></span>
                <input class="uk-search-input" type="search" placeholder="Search" x-model="searchQuery">
            </form>
        </div>
        <div class="uk-margin-bottom uk-width-1-4@s">
            <select class="uk-select" @change="handleSortChange($event)">
            <option value="title:1"{% if sort_title_asc %} selected{% endif %}>▲ Name</option>
            <option value="title:0"{% if sort_title_desc %} selected{% endif %}>▼ Name</option>
            <option value="modified:1"{% if sort_modified_asc %} selected{% endif %}>▲ Date Modified</option>
            <option value="modified:0"{% if sort_modified_desc %} selected{% endif %}>▼ Date Modified</option>
            <option value="progress:1"{% if sort_progress_asc %} selected{% endif %}>▲ Progress</option>
            <option value="progress:0"{% if sort_progress_desc %} selected{% endif %}>▼ Progress</option>
            </select>
        </div>
    </div>

    <!-- Entries Grid -->
    <div class="entries-grid">
        {% for entry in entries %}
        <div class="entry-card item"
             x-show="matchesSearch('{{ entry.entry_name }}')"
             @click="openModal('{{ title_id }}', '{{ entry.entry_id }}', '{{ entry.entry_name }}', '{{ entry.path }}', {{ entry.pages }}, {{ entry.progress }}, {{ entry.saved_page }})">
            <div class="entry-thumbnail">
                <img src="/api/cover/{{ title_id }}/{{ entry.entry_id }}" alt="{{ entry.entry_name }}" loading="lazy">
                <div class="progress-badge">{{ entry.progress }}%</div>
            </div>
            <div class="entry-info">
                <div class="entry-name uk-card-title">{{ entry.entry_name }}</div>
                <div class="entry-stats">{{ entry.pages }} pages</div>
            </div>
        </div>
        {% endfor %}

        {% if entries.is_empty() %}
        <p>No entries found.</p>
        {% endif %}
    </div>

    <!-- Entry Modal -->
    <div id="entry-modal" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <button class="uk-modal-close-default" type="button" uk-close></button>

            <h3 x-text="modalData.entryName">Entry Name</h3>
            <p class="modal-entry-path" x-text="modalData.entryPath">/path/to/entry</p>
            <p class="modal-entry-pages" x-text="`${modalData.pages} pages`">0 pages</p>

            <div class="modal-section">
                <h4>Read</h4>
                <div class="button-group">
                    <a :href="`/reader/${modalData.titleId}/${modalData.entryId}/1`" class="uk-button uk-button-default">From Beginning</a>
                    <a :href="`/reader/${modalData.titleId}/${modalData.entryId}/${modalData.resumePage}`"
                       class="uk-button uk-button-primary"
                       x-show="modalData.progress > 0 && modalData.progress < 100">
                        Continue from <span x-text="`${modalData.progress.toFixed(1)}%`">0.0%</span>
                    </a>
                </div>
            </div>

            <div class="modal-section">
                <h4>Progress</h4>
                <div class="button-group">
                    <button class="uk-button uk-button-default" @click="markAsRead()">Mark as read (100%)</button>
                    <button class="uk-button uk-button-default" @click="markAsUnread()">Mark as unread (0%)</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/book.js"></script>
{% endblock %}
