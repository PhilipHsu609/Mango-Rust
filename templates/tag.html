{% extends "base.html" %}

{% block title %}Tag: {{ tag }}{% endblock %}

{% block content %}
<div x-data="tagViewData()">
    <h2 class="uk-title">Tag: {{ tag }}</h2>
    <p class="uk-text-meta">{{ title_count }} {% if title_count == 1 %}title{% else %}titles{% endif %} tagged</p>

    <!-- Search and Sort Controls -->
    <div class="uk-grid-small" uk-grid>
        <div class="uk-margin-bottom uk-width-3-4@s">
            <form class="uk-search uk-search-default">
                <span uk-search-icon></span>
                <input class="uk-search-input" type="search" placeholder="Search" x-model="searchQuery">
            </form>
        </div>
        <div class="uk-margin-bottom uk-width-1-4@s">
            <select class="uk-select" @change="handleSortChange($event)">
            <option value="title:1"{% if sort_name_asc %} selected{% endif %}>▲ Name</option>
            <option value="title:0"{% if sort_name_desc %} selected{% endif %}>▼ Name</option>
            <option value="modified:1"{% if sort_time_asc %} selected{% endif %}>▲ Date Modified</option>
            <option value="modified:0"{% if sort_time_desc %} selected{% endif %}>▼ Date Modified</option>
            <option value="progress:1"{% if sort_progress_asc %} selected{% endif %}>▲ Progress</option>
            <option value="progress:0"{% if sort_progress_desc %} selected{% endif %}>▼ Progress</option>
            </select>
        </div>
    </div>

    <!-- Titles Grid - using UIkit card structure like original Mango -->
    <div class="uk-child-width-1-4@m uk-child-width-1-2" uk-grid>
        {% for title in titles %}
        <div class="item" x-show="matchesSearch('{{ title.name }}')">
            <div class="acard" onclick="location='/book/{{ title.id }}'">
                <div class="uk-card uk-card-default">
                    <div class="uk-card-media-top uk-inline">
                        {% match title.first_entry_id %}
                        {% when Some with (entry_id) %}
                        <img data-src="/api/cover/{{ title.id }}/{{ entry_id }}" width="100%" height="100%" alt="{{ title.name }}" uk-img>
                        {% when None %}
                        <img data-src="/static/img/placeholder.png" width="100%" height="100%" alt="{{ title.name }}" uk-img>
                        {% endmatch %}
                    </div>
                    <div class="uk-card-body">
                        <div class="uk-card-badge label">{{ title.progress_display }}%</div>
                        <h3 class="uk-card-title break-word">{{ title.name }}</h3>
                        <p class="uk-text-meta">{{ title.entry_count }} {% if title.entry_count == 1 %}entry{% else %}entries{% endif %}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {% if titles.is_empty() %}
        <p>No titles found with this tag.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function tagViewData() {
    return {
        searchQuery: '',

        matchesSearch(name) {
            if (this.searchQuery.trim() === '') return true;
            return name.toLowerCase().includes(this.searchQuery.toLowerCase());
        },

        handleSortChange(event) {
            const value = event.target.value;
            const [sort, ascend] = value.split(':');
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('sort', sort);
            urlParams.set('ascend', ascend);
            window.location.search = urlParams.toString();
        }
    };
}
</script>
{% endblock %}
