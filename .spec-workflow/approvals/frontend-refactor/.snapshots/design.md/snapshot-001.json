{
  "id": "snapshot_1763793134486_ou7gzztsj",
  "approvalId": "approval_1763793134482_kvyyfrlo8",
  "approvalTitle": "Frontend Refactoring - Design Document",
  "version": 1,
  "timestamp": "2025-11-22T06:32:14.486Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Frontend Refactoring\n\n## Overview\n\nThis design outlines the technical architecture for refactoring Mango-Rust's frontend from its current state (inline CSS/JS, scattered files) to a clean, maintainable structure that exceeds the original Mango's quality. The refactoring will reorganize 3,875 lines of frontend code across templates, CSS, and JavaScript while maintaining 100% functional compatibility.\n\n**Key Goals:**\n1. Extract 383 lines of inline CSS from base.html into organized LESS files\n2. Move reader.css and reader.js from inline includes to static assets\n3. Consolidate dark mode styles (scattered across 5+ files) into one source\n4. Implement a build system for LESS compilation\n5. Create reusable template components to eliminate duplication\n6. Optimize Alpine.js usage (reduce by >50% for non-reactive cases)\n7. Improve code organization and maintainability\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n*Note: No steering docs exist yet - following Rust and web best practices:*\n\n- **Separation of Concerns**: CSS in stylesheets, JS in modules, templates for structure\n- **Single Responsibility**: Each file has one clear purpose\n- **DRY Principle**: Components eliminate duplication\n- **Performance First**: Minified assets, proper caching, optimized loading\n- **Maintainability**: Clear file organization, consistent naming, documented patterns\n\n### Project Structure (structure.md)\n*Note: Establishing new frontend structure:*\n\n```\nstatic/\n  src/          # Source files (not served directly)\n    css/\n      base.less           # Core layout and typography\n      dark-theme.less     # ALL dark mode styles (consolidate from 5+ files)\n      components/         # Component-specific styles\n        nav.less\n        modal.less\n        card.less\n      pages/              # Page-specific styles\n        library.less\n        reader.less\n        book.less\n        home.less\n    js/\n      core.js             # Shared utilities, theme management\n      pages/              # Page-specific modules\n        library.js\n        reader.js\n        book.js\n        home.js\n        admin.js\n  dist/         # Compiled output (served to browser)\n    css/\n      main.css          # Compiled & minified\n      main.css.map      # Source maps\n    js/\n      main.js           # Bundled & minified\n      main.js.map       # Source maps\n\ntemplates/\n  components/   # Reusable template components\n    nav.html\n    modal-base.html\n    card.html\n  pages/        # Page templates (moved from root)\n    library.html\n    book.html\n    reader.html\n    home.html\n  base.html     # Clean base (NO inline CSS/JS)\n```\n\n## Code Reuse Analysis\n\n### Existing Code to Leverage\n\n**From Original Mango (`Mango/public/`):**\n- **mango.less**: LESS compilation patterns, variable usage\n- **common.js**: Theme management, localStorage patterns\n- **reader.js**: Alpine.js component structure (3.7k vs our 495 lines - we're overengineered)\n- **search.js**: Simple jQuery search pattern (597 lines - simpler than our Alpine version)\n\n**From Current Mango-Rust:**\n- **theme.js** (87 lines): Keep theme toggle logic, integrate with core.js\n- **UIKit 3.5.9**: Keep existing version for stability (don't upgrade mid-refactor)\n- **Alpine.js 3.13.3**: Keep version, but use more selectively\n- **Existing templates**: Preserve all functionality, just extract inline code\n\n### Integration Points\n\n**Rust Backend (Unchanged):**\n- **Askama templates**: Continue using {% include %} for components\n- **Static file routes**: `/static/css/*` and `/static/js/*` already configured\n- **No Rust code changes**: Backend serves pre-compiled CSS/JS from static/dist/\n\n**Build System:**\n- **LESS compiler**: Integrate into development workflow\n- **Watch mode**: Auto-recompile on file changes\n- **Production build**: Minify + source maps\n\n## Architecture\n\n### Overall Design Pattern: **Component-Based Static Site Generation**\n\nWe're adopting the original Mango's approach but modernized:\n- **LESS for CSS**: Compile-time processing (like original)\n- **Modular JavaScript**: Each page loads only what it needs (like original)\n- **Template Components**: Reusable Askama includes (better than ECR)\n- **Minimal Alpine.js**: Only for reactive state (tags, modals)\n\n```mermaid\ngraph TD\n    A[Source Files] --> B[Build System]\n    B --> C[Compiled Assets]\n    C --> D[Static Server]\n    D --> E[Browser]\n\n    A1[static/src/css/*.less] --> B1[LESS Compiler]\n    A2[static/src/js/*.js] --> B2[Optional: esbuild]\n\n    B1 --> C1[static/dist/css/main.css]\n    B2 --> C2[static/dist/js/*.js]\n\n    T1[templates/components/] --> T2[Askama Template Engine]\n    T2 --> T3[Rendered HTML]\n\n    C1 --> D\n    C2 --> D\n    T3 --> D\n\n    style A fill:#f9f,stroke:#333\n    style B fill:#bbf,stroke:#333\n    style C fill:#bfb,stroke:#333\n```\n\n### Modular Design Principles\n\n**1. CSS Organization (LESS Architecture)**\n\n```less\n// static/src/css/main.less\n@import 'variables';      // Colors, sizes, breakpoints\n@import 'base';           // Core layout, typography\n@import 'components/nav'; // Navigation component\n@import 'components/modal';\n@import 'components/card';\n@import 'pages/library';  // Page-specific overrides\n@import 'pages/reader';\n@import 'dark-theme';     // LAST: overrides everything\n```\n\n**2. JavaScript Organization**\n\n```javascript\n// static/src/js/core.js - Loaded on all pages\n- Theme management (from theme.js)\n- localStorage utilities\n- Common event handlers\n- Alpine.js initialization\n\n// static/src/js/pages/library.js - Only on /library\nfunction libraryPage() {\n    // Simple vanilla JS search\n    document.querySelector('.search-input').addEventListener('input', ...);\n}\n\n// static/src/js/pages/reader.js - Only on /reader\nfunction readerComponent() {\n    // Alpine.js component for reactive reader state\n    return { ... };\n}\n```\n\n**3. Template Components**\n\n```html\n<!-- templates/components/nav.html -->\n{% macro nav(home_active, library_active, admin_active, is_admin) %}\n<nav class=\"uk-navbar-container\" uk-navbar>\n    <!-- Single source of truth for navigation -->\n    <ul class=\"uk-navbar-nav\">\n        <li{% if home_active %} class=\"uk-active\"{% endif %}>\n            <a href=\"/\">HOME</a>\n        </li>\n        <!-- ... -->\n    </ul>\n</nav>\n{% endmacro %}\n\n<!-- templates/base.html -->\n{% from \"components/nav.html\" import nav %}\n{{ nav(home_active, library_active, admin_active, is_admin) }}\n```\n\n## Components and Interfaces\n\n### Component 1: CSS Build System\n\n**Purpose:** Compile LESS to optimized CSS\n\n**Files:**\n- **Input**: `static/src/css/**/*.less`\n- **Output**: `static/dist/css/main.css` (minified)\n- **Tool**: `lessc` (Node.js LESS compiler)\n\n**Build Script** (`build-css.sh`):\n```bash\n#!/bin/bash\nlessc static/src/css/main.less static/dist/css/main.css --compress\necho \"CSS compiled successfully\"\n```\n\n**Watch Script** (`watch-css.sh`):\n```bash\n#!/bin/bash\nlessc static/src/css/main.less static/dist/css/main.css --compress --watch\n```\n\n**Dependencies:**\n- None (standalone Node.js tool)\n\n**Reuses:**\n- Original Mango's LESS compilation pattern\n\n---\n\n### Component 2: Core JavaScript Module\n\n**Purpose:** Shared utilities loaded on all pages\n\n**File:** `static/src/js/core.js`\n\n**Public Interface:**\n```javascript\n// Theme Management\nfunction toggleTheme() { ... }\nfunction applyTheme(theme) { ... }\nfunction getTheme() { ... }\n\n// localStorage Helpers\nfunction savePreference(key, value) { ... }\nfunction loadPreference(key, defaultValue) { ... }\n\n// Initialization\ndocument.addEventListener('DOMContentLoaded', () => {\n    // Apply theme before render (prevent FOUC)\n    applyTheme(getTheme());\n    // Initialize Alpine.js if present\n    if (window.Alpine) {\n        window.Alpine.start();\n    }\n});\n```\n\n**Dependencies:**\n- Browser localStorage API\n- Optional: Alpine.js (if loaded on page)\n\n**Reuses:**\n- Current `theme.js` logic\n- Original Mango's `common.js` patterns\n\n---\n\n### Component 3: Library Page Module\n\n**Purpose:** Library-specific JavaScript (search, sort)\n\n**File:** `static/src/js/pages/library.js`\n\n**Public Interface:**\n```javascript\n// Search functionality (vanilla JS, not Alpine)\nfunction initLibrarySearch() {\n    const searchInput = document.querySelector('.uk-search-input');\n    const cards = document.querySelectorAll('.title-card');\n\n    searchInput.addEventListener('input', (e) => {\n        const query = e.target.value.toLowerCase();\n        cards.forEach(card => {\n            const name = card.dataset.titleName.toLowerCase();\n            card.style.display = name.includes(query) ? '' : 'none';\n        });\n    });\n}\n\n// Sort functionality (persisted to localStorage)\nfunction initLibrarySort() {\n    const sortSelect = document.querySelector('.sort-select');\n    const saved = loadPreference('library-sort', 'name');\n    sortSelect.value = saved;\n\n    sortSelect.addEventListener('change', (e) => {\n        savePreference('library-sort', e.target.value);\n        window.location.reload(); // Server-side sort\n    });\n}\n\n// Page initialization\ndocument.addEventListener('DOMContentLoaded', () => {\n    initLibrarySearch();\n    initLibrarySort();\n});\n```\n\n**Dependencies:**\n- `core.js` (for savePreference/loadPreference)\n\n**Reuses:**\n- Original Mango's `search.js` approach (simpler than Alpine)\n\n---\n\n### Component 4: Reader Page Module\n\n**Purpose:** Reader-specific JavaScript (page navigation, settings)\n\n**File:** `static/src/js/pages/reader.js`\n\n**Public Interface:**\n```javascript\n// Alpine.js component (reactive state needed here)\nfunction readerComponent() {\n    return {\n        currentPage: {{ page }},\n        totalPages: {{ total_pages }},\n        pages: [],\n\n        // Navigate to page\n        goToPage(num) {\n            window.location.href = `/reader/{{ title_id }}/{{ entry_id }}/${num}`;\n        },\n\n        // Keyboard shortcuts\n        init() {\n            document.addEventListener('keydown', (e) => {\n                if (e.key === 'ArrowRight') this.nextPage();\n                if (e.key === 'ArrowLeft') this.prevPage();\n            });\n        },\n\n        nextPage() {\n            if (this.currentPage < this.totalPages) {\n                this.goToPage(this.currentPage + 1);\n            }\n        },\n\n        prevPage() {\n            if (this.currentPage > 1) {\n                this.goToPage(this.currentPage - 1);\n            }\n        }\n    };\n}\n```\n\n**Dependencies:**\n- Alpine.js (reactive state management)\n- Server-rendered template variables\n\n**Reuses:**\n- Original Mango's `reader.js` Alpine.js pattern (but simpler)\n\n---\n\n### Component 5: Template Navigation Component\n\n**Purpose:** Single source of truth for navigation across desktop and mobile\n\n**File:** `templates/components/nav.html`\n\n**Public Interface:**\n```jinja2\n{% macro nav(active_page, is_admin) %}\n    <!-- Desktop Navigation -->\n    <nav class=\"uk-navbar-container uk-visible@m\">\n        <ul class=\"uk-navbar-nav\">\n            <li{% if active_page == \"home\" %} class=\"uk-active\"{% endif %}>\n                <a href=\"/\">Home</a>\n            </li>\n            <!-- ... other items ... -->\n        </ul>\n    </nav>\n\n    <!-- Mobile Navigation (same items, different styling) -->\n    <div id=\"mobile-nav\" uk-offcanvas>\n        <ul class=\"uk-nav\">\n            <li{% if active_page == \"home\" %} class=\"uk-active\"{% endif %}>\n                <a href=\"/\">Home</a>\n            </li>\n            <!-- ... same items ... -->\n        </ul>\n    </div>\n{% endmacro %}\n```\n\n**Usage in base.html:**\n```jinja2\n{% from \"components/nav.html\" import nav %}\n{{ nav(\"home\", is_admin) }}\n```\n\n**Dependencies:**\n- Askama template engine\n- UIKit CSS for styling\n\n**Reuses:**\n- Current navigation HTML structure\n- Consolidates desktop + mobile into one component\n\n---\n\n### Component 6: Dark Theme LESS Module\n\n**Purpose:** ALL dark mode styles in one file\n\n**File:** `static/src/css/dark-theme.less`\n\n**Structure:**\n```less\n// Dark theme color variables\n@dark-bg: rgb(20, 20, 20);\n@dark-bg-elevated: #2a2a2a;\n@dark-bg-input: #1a1a1a;\n@dark-border: #3a3a3a;\n@dark-text-primary: #e5e5e5;\n@dark-text-secondary: #aaa;\n\n// Global dark mode\nbody.uk-light {\n    background: @dark-bg;\n    color: @dark-text-primary;\n\n    // Navigation\n    .uk-navbar-container {\n        background: @dark-bg-elevated !important;\n        border-bottom: 1px solid @dark-border;\n    }\n\n    // Forms\n    .uk-input, .uk-textarea, .uk-select {\n        background: @dark-bg-input;\n        border-color: @dark-border;\n        color: @dark-text-primary;\n    }\n\n    // Modals\n    .uk-modal-dialog {\n        background: @dark-bg-elevated;\n        color: @dark-text-primary;\n    }\n\n    // ... (all dark mode styles from base.html lines 110-317)\n}\n```\n\n**Dependencies:**\n- LESS compiler\n- `variables.less` for color definitions\n\n**Reuses:**\n- Existing dark mode styles from base.html\n- Consolidates styles from library.css, book.css, home.css\n\n## Data Models\n\n### CSS Variables Model\n```less\n// variables.less\n@primary-color: #1e87f0;\n@background-light: #fafafa;\n@background-dark: rgb(20, 20, 20);\n@text-light: #333;\n@text-dark: #e5e5e5;\n@breakpoint-small: 640px;\n@breakpoint-medium: 960px;\n@breakpoint-large: 1200px;\n```\n\n### JavaScript State Model (Reader)\n```javascript\n{\n    currentPage: number,\n    totalPages: number,\n    titleId: string,\n    entryId: string,\n    pages: Array<{ id: number, url: string }>,\n    loading: boolean\n}\n```\n\n### Template Data Model (Navigation)\n```rust\nstruct NavData {\n    active_page: String,      // \"home\" | \"library\" | \"admin\"\n    is_admin: bool,\n    username: String\n}\n```\n\n## Error Handling\n\n### Scenario 1: LESS Compilation Failure\n\n**Description:** Developer edits invalid LESS syntax\n\n**Handling:**\n```bash\n# watch-css.sh\nlessc static/src/css/main.less static/dist/css/main.css --compress 2>&1 | tee /dev/stderr\nif [ $? -ne 0 ]; then\n    echo \"ERROR: LESS compilation failed. Check syntax.\"\n    exit 1\nfi\n```\n\n**User Impact:** Development server continues running, error shown in terminal\n\n---\n\n### Scenario 2: Missing Static File in Production\n\n**Description:** Compiled CSS/JS not deployed\n\n**Handling:**\n- Rust returns 404 for missing static files\n- Browser console shows error\n- Fallback: Inline critical CSS in base.html (emergency)\n\n**User Impact:** Page loads but unstyled (graceful degradation)\n\n---\n\n### Scenario 3: JavaScript Module Load Failure\n\n**Description:** Network error loading JS file\n\n**Handling:**\n```html\n<script src=\"/static/js/core.js\" onerror=\"console.error('Failed to load core.js')\"></script>\n```\n\n**User Impact:** Core features work (server-rendered), advanced features unavailable\n\n## Testing Strategy\n\n### Unit Testing\n\n**CSS Visual Regression:**\n- Screenshot tests for each page in light/dark mode\n- Compare before/after refactoring\n- Tools: Playwright MCP + pixel comparison\n\n**JavaScript Unit Tests:**\n- Test theme toggle function\n- Test localStorage helpers\n- Test search filter logic\n- Tool: Manual Playwright testing (no test framework needed for now)\n\n### Integration Testing\n\n**Build System:**\n1. Modify LESS file\n2. Verify CSS recompiles\n3. Verify minification works\n4. Verify source maps generated\n\n**Template Components:**\n1. Modify nav component\n2. Verify changes appear on all pages\n3. Verify mobile and desktop both update\n\n### End-to-End Testing\n\n**User Scenarios (via Playwright MCP):**\n\n1. **Library Search**\n   - Load /library\n   - Type in search box\n   - Verify cards filter correctly\n   - Compare to current behavior (must be identical)\n\n2. **Theme Toggle**\n   - Load /library in light mode\n   - Click theme toggle\n   - Verify dark mode applied\n   - Reload page, verify persists\n   - Navigate to /book, verify still dark\n\n3. **Reader Navigation**\n   - Load /reader page\n   - Press right arrow key\n   - Verify advances to next page\n   - Verify progress saved\n   - Compare to current behavior\n\n4. **Mobile Navigation**\n   - Resize browser to <960px\n   - Verify hamburger menu appears\n   - Click hamburger\n   - Verify offcanvas opens\n   - Click nav item\n   - Verify navigation works\n\n5. **Dark Mode Across Pages**\n   - Enable dark mode on /library\n   - Navigate to /book\n   - Verify dark mode persists\n   - Navigate to /reader\n   - Verify dark mode persists\n   - Check modals are dark themed\n\n## Build System Implementation\n\n### Development Workflow\n\n```bash\n# Install LESS compiler (one-time)\nnpm install -g less\n\n# Development mode (auto-recompile on changes)\n./watch-css.sh &\ncargo watch -x run\n\n# Production build\n./build-css.sh\ncargo build --release\n```\n\n### Build Scripts\n\n**`watch-css.sh`:**\n```bash\n#!/bin/bash\necho \"Watching LESS files for changes...\"\nlessc --watch static/src/css/main.less static/dist/css/main.css --compress --source-map\n```\n\n**`build-css.sh`:**\n```bash\n#!/bin/bash\necho \"Building CSS...\"\nmkdir -p static/dist/css\nlessc static/src/css/main.less static/dist/css/main.css --compress --source-map\necho \"✓ CSS compiled to static/dist/css/main.css\"\n```\n\n**Add to `.gitignore`:**\n```\nstatic/dist/\nnode_modules/\n```\n\n**Add to README.md:**\n```markdown\n## Frontend Development\n\n### Prerequisites\n- Node.js (for LESS compiler)\n\n### Setup\nnpm install -g less\n\n### Development\n./watch-css.sh    # Auto-recompile CSS on changes\ncargo watch -x run # Auto-restart server on Rust changes\n\n### Production Build\n./build-css.sh\ncargo build --release\n```\n\n## Migration Path\n\n### Phase 1: Setup Build System\n1. Create `static/src/css/` and `static/dist/css/` directories\n2. Create build scripts (`build-css.sh`, `watch-css.sh`)\n3. Test compilation works\n\n### Phase 2: Extract Base CSS\n1. Copy inline CSS from base.html to `base.less`\n2. Update base.html to load compiled CSS\n3. Verify pages render identically\n\n### Phase 3: Extract Dark Theme\n1. Extract dark mode styles to `dark-theme.less`\n2. Remove from base.html, library.css, book.css, home.css\n3. Test theme toggle works\n\n### Phase 4: Extract Page CSS\n1. Move page-specific styles to `pages/*.less`\n2. Import in main.less\n3. Test each page individually\n\n### Phase 5: Create Template Components\n1. Extract navigation to `components/nav.html`\n2. Update base.html to use component\n3. Remove duplicate mobile nav code\n\n### Phase 6: Organize JavaScript\n1. Move reader.js to static/src/js/pages/\n2. Extract shared code to core.js\n3. Update script tags in templates\n\n### Phase 7: Optimize Alpine.js\n1. Replace simple Alpine usage with vanilla JS (library search)\n2. Keep Alpine for reactive components (reader, tags)\n3. Test all interactions work\n\n### Phase 8: Final Polish\n1. Minify CSS/JS\n2. Add source maps\n3. Performance testing\n4. Visual regression testing\n\n## Performance Targets\n\n**Before Refactoring:**\n- base.html: 383 lines (including 300+ lines of CSS)\n- Total CSS: ~1,200 lines across multiple files\n- JavaScript: Inline + scattered modules\n\n**After Refactoring:**\n- base.html: ~100 lines (pure structure, no styles)\n- Compiled CSS: <50KB gzipped\n- Compiled JS: <100KB total\n- First Contentful Paint: <1s on 3G\n- Time to Interactive: <2s on 3G\n\n## Risks and Mitigation\n\n**Risk 1: Breaking Visual Appearance**\n- **Mitigation**: Screenshot testing before/after each phase\n- **Fallback**: Git revert if issues found\n\n**Risk 2: LESS Compilation Complexity**\n- **Mitigation**: Keep LESS simple (no advanced features)\n- **Fallback**: Can compile manually if watch fails\n\n**Risk 3: Template Component Complexity**\n- **Mitigation**: Start with simple components (nav only)\n- **Fallback**: Keep existing templates if components problematic\n\n**Risk 4: Alpine.js Removal Breaking Features**\n- **Mitigation**: Test each replacement thoroughly\n- **Fallback**: Keep Alpine where truly needed\n\n## Success Metrics\n\nThe refactoring is successful when:\n\n1. ✅ **Zero inline CSS** in any template (<style> tags removed)\n2. ✅ **Zero inline JavaScript** using {% include %} (proper <script src> instead)\n3. ✅ **Build system works** (LESS compiles automatically)\n4. ✅ **Visual parity** (screenshots match pixel-for-pixel)\n5. ✅ **Functional parity** (all features work identically)\n6. ✅ **Performance improvement** (CSS <50KB, faster loads)\n7. ✅ **Code reduction** (30% fewer template lines via components)\n8. ✅ **Maintainability** (developers can find/modify code easily)\n9. ✅ **Linus approval** (or at least fewer complaints)\n\n## Conclusion\n\nThis design transforms Mango-Rust's frontend from a tangled mess of inline styles and scattered JavaScript into a clean, maintainable architecture that exceeds the original Mango's quality. By adopting LESS compilation, creating reusable components, and organizing code logically, we make the codebase easier to understand, modify, and extend.\n\nThe migration path is conservative and incremental, testing each phase before proceeding. The result will be a frontend that's not just as good as the original Mango—it will be better.\n",
  "fileStats": {
    "size": 20718,
    "lines": 768,
    "lastModified": "2025-11-22T06:32:08.377Z"
  },
  "comments": []
}