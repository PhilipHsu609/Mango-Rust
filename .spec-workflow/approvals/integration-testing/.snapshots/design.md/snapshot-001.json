{
  "id": "snapshot_1763795954916_kr2zexwrs",
  "approvalId": "approval_1763795954905_qh3ht2n1q",
  "approvalTitle": "Integration Testing Framework - Design",
  "version": 1,
  "timestamp": "2025-11-22T07:19:14.916Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Integration Testing Framework\n\n## Overview\n\nThe Integration Testing Framework will provide automated, browser-based tests for Mango-Rust using Playwright. The framework will be built as a standalone Node.js test suite that interacts with the running Mango server, verifying frontend-backend interactions, theme system, reader functionality, and navigation flows.\n\nThe testing framework will follow a modular architecture with reusable utilities, organized test suites, and comprehensive reporting capabilities. Tests will run both locally during development and automatically in CI/CD pipelines.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n*Note: Steering documents not yet created. This design follows general best practices for test frameworks.*\n\n**Testing Standards:**\n- Use industry-standard tools (Playwright for browser automation)\n- Follow page object pattern for maintainable tests\n- Separate test utilities from test specifications\n- Use TypeScript for type safety and better IDE support\n\n### Project Structure (structure.md)\n\n**Test Organization:**\n```\ntests/\n├── integration/           # Integration test suites\n│   ├── theme.spec.ts     # Theme toggle tests\n│   ├── reader.spec.ts    # Reader functionality tests\n│   ├── navigation.spec.ts # Page navigation tests\n│   └── auth.spec.ts      # Authentication tests\n├── helpers/              # Reusable test utilities\n│   ├── test-utils.ts     # Common test helpers\n│   ├── page-objects.ts   # Page object models\n│   └── fixtures.ts       # Test fixtures and data\n├── reports/              # Test execution reports (gitignored)\n└── screenshots/          # Test evidence (gitignored)\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **Playwright MCP Server**: Already integrated in Claude Code environment, provides browser automation capabilities\n- **Build Scripts**: `build-css.sh` will be used to ensure CSS is compiled before tests run\n- **Server Binary**: `cargo run --release` used to start Mango server for testing\n\n### Integration Points\n\n- **Running Mango Server**: Tests will start server on localhost:9000 and wait for readiness\n- **Database**: Tests will use temporary test database to avoid affecting development data\n- **Static Assets**: Tests will verify `/static/dist/css/main.css` and `/static/js/core.js` load correctly\n- **LocalStorage**: Tests will interact with browser localStorage for theme preferences\n- **Session Management**: Tests will authenticate and maintain sessions for protected pages\n\n## Architecture\n\nThe testing framework follows a **layered architecture** with clear separation of concerns:\n\n```mermaid\ngraph TD\n    A[Test Specs] --> B[Page Objects]\n    A --> C[Test Utilities]\n    B --> D[Playwright Browser]\n    C --> D\n    D --> E[Mango Server]\n\n    F[Test Runner] --> A\n    F --> G[Test Reporter]\n    G --> H[HTML Report]\n    G --> I[Screenshots]\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Each test file tests one feature area (theme, reader, navigation)\n- **Component Isolation**: Page objects encapsulate page-specific selectors and interactions\n- **Service Layer Separation**: Test utilities provide reusable functions independent of specific pages\n- **Utility Modularity**: Helpers broken into focused modules (assertions, waits, screenshots, setup)\n\n### Design Patterns\n\n1. **Page Object Pattern**: Encapsulate page structures and interactions\n2. **Test Fixtures**: Provide consistent test setup and teardown\n3. **Builder Pattern**: Construct complex test scenarios incrementally\n4. **Helper Functions**: Extract common patterns into reusable utilities\n\n## Components and Interfaces\n\n### Component 1: Test Runner Configuration\n\n- **Purpose:** Configure Playwright test runner with browsers, timeouts, and reporters\n- **Interfaces:**\n  - `playwright.config.ts`: Playwright configuration file\n  - Exports test options, browser settings, base URL\n- **Dependencies:** Playwright Test framework\n- **Reuses:** Standard Playwright configuration patterns\n\n**Configuration Options:**\n```typescript\n{\n  testDir: './tests/integration',\n  timeout: 30000,\n  retries: 2,\n  use: {\n    baseURL: 'http://localhost:9000',\n    screenshot: 'only-on-failure',\n    video: 'retain-on-failure'\n  }\n}\n```\n\n### Component 2: Page Objects\n\n- **Purpose:** Encapsulate page-specific selectors and interactions\n- **Interfaces:**\n  - `LibraryPage`: Navigate, search, sort, verify titles\n  - `BookPage`: View entries, open modals, manage tags, check progress\n  - `ReaderPage`: Navigate pages, change modes, verify images load\n  - `NavigationComponent`: Toggle theme, navigate menu, verify active page\n- **Dependencies:** Playwright Page API\n- **Reuses:** Common selector patterns, wait strategies\n\n**Interface Example:**\n```typescript\nclass LibraryPage {\n  constructor(page: Page);\n  async navigate(): Promise<void>;\n  async search(query: string): Promise<void>;\n  async selectSort(option: string): Promise<void>;\n  async getTitleCards(): Promise<ElementHandle[]>;\n  async verifyTitleExists(name: string): Promise<boolean>;\n}\n```\n\n### Component 3: Test Utilities\n\n- **Purpose:** Provide reusable helper functions for common test operations\n- **Interfaces:**\n  - `login(page, username, password)`: Authenticate user\n  - `verifyTheme(page, expectedTheme)`: Check current theme state\n  - `captureEvidence(page, name)`: Take screenshot and save console logs\n  - `waitForPageLoad(page)`: Wait for page to be fully loaded\n  - `startServer()`: Launch Mango server and wait for ready\n  - `stopServer()`: Gracefully shutdown server\n- **Dependencies:** Playwright Page API, Node.js child_process\n- **Reuses:** Standard wait strategies, assertion patterns\n\n**Utility Functions:**\n```typescript\n// Theme verification\nasync function verifyTheme(page: Page, expected: 'light' | 'dark'): Promise<void> {\n  const hasUkLight = await page.evaluate(() =>\n    document.body.classList.contains('uk-light')\n  );\n  const theme = await page.evaluate(() =>\n    localStorage.getItem('theme')\n  );\n\n  if (expected === 'dark') {\n    expect(hasUkLight).toBe(true);\n    expect(theme).toBe('dark');\n  } else {\n    expect(hasUkLight).toBe(false);\n    expect(theme).toBe('light');\n  }\n}\n\n// Server management\nasync function startServer(): Promise<ChildProcess> {\n  const server = spawn('cargo', ['run', '--release'], {\n    cwd: projectRoot,\n    env: { ...process.env, RUST_LOG: 'info' }\n  });\n\n  await waitForServerReady('http://localhost:9000');\n  return server;\n}\n```\n\n### Component 4: Test Fixtures\n\n- **Purpose:** Provide consistent test setup and teardown\n- **Interfaces:**\n  - `test.beforeAll()`: Start server, build CSS\n  - `test.afterAll()`: Stop server, clean up temp files\n  - `test.beforeEach()`: Navigate to page, clear localStorage\n  - `test.afterEach()`: Capture screenshots on failure\n- **Dependencies:** Playwright Test hooks\n- **Reuses:** Test utilities for server/browser management\n\n### Component 5: Test Suites\n\n- **Purpose:** Organize tests by feature area\n- **Interfaces:**\n  - `theme.spec.ts`: Theme toggle, persistence, visual verification\n  - `reader.spec.ts`: Page navigation, mode switching, keyboard shortcuts\n  - `navigation.spec.ts`: Menu links, page routing, active states\n  - `auth.spec.ts`: Login, logout, session persistence\n- **Dependencies:** Page objects, test utilities\n- **Reuses:** Common test fixtures and helpers\n\n## Data Models\n\n### TestConfig\n\n```typescript\ninterface TestConfig {\n  baseURL: string;           // Server URL (e.g., 'http://localhost:9000')\n  timeout: number;           // Default test timeout in ms\n  retries: number;           // Number of retries on failure\n  headless: boolean;         // Run browser in headless mode\n  slowMo: number;            // Slow down operations for debugging\n  screenshotDir: string;     // Directory for test screenshots\n  reportDir: string;         // Directory for HTML reports\n}\n```\n\n### PageState\n\n```typescript\ninterface PageState {\n  url: string;               // Current page URL\n  title: string;             // Page title\n  theme: 'light' | 'dark';   // Current theme\n  isAuthenticated: boolean;  // User logged in?\n  consoleErrors: string[];   // JavaScript errors on page\n}\n```\n\n### TestResult\n\n```typescript\ninterface TestResult {\n  testName: string;          // Name of test\n  status: 'passed' | 'failed' | 'skipped';\n  duration: number;          // Test execution time (ms)\n  error?: string;            // Error message if failed\n  screenshots: string[];     // Paths to screenshots\n  retries: number;           // Number of retries attempted\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Server fails to start**\n   - **Handling:** Retry 3 times with exponential backoff, fail suite if still unsuccessful\n   - **User Impact:** Clear error message indicating server startup failed, suggest checking if port 9000 is in use\n\n2. **Page load timeout**\n   - **Handling:** Retry once, capture network logs, take screenshot\n   - **User Impact:** Test fails with screenshot showing loading state, network log shows which resource failed\n\n3. **Element not found**\n   - **Handling:** Wait with retry (5 seconds), take screenshot if still not found\n   - **User Impact:** Clear error message showing which element was not found and page snapshot\n\n4. **Theme toggle doesn't work**\n   - **Handling:** Capture before/after screenshots, dump localStorage state, fail test\n   - **User Impact:** Visual evidence of what went wrong with theme system\n\n5. **JavaScript console errors**\n   - **Handling:** Collect all console.error messages, include in test report\n   - **User Impact:** Test report shows which pages have JavaScript errors\n\n6. **Database connection failed**\n   - **Handling:** Check if test database exists, create if missing, retry connection\n   - **User Impact:** Informative error about database setup\n\n## Testing Strategy\n\n### Unit Testing\n\n**Not applicable** - This spec is for integration testing framework itself. The framework will enable integration tests for Mango-Rust features.\n\n### Integration Testing\n\n**Core Flows to Test:**\n\n1. **Theme System Flow**\n   - Load page in default theme\n   - Click theme toggle\n   - Verify body class changes\n   - Verify localStorage updates\n   - Verify colors change (navbar, cards, text)\n   - Refresh page\n   - Verify theme persists\n   - Navigate to different page\n   - Verify theme remains consistent\n\n2. **Reader Functionality Flow**\n   - Navigate to book page\n   - Click entry to open reader\n   - Verify reader loads without JS errors\n   - Verify first page displays\n   - Press right arrow key\n   - Verify page changes\n   - Open settings modal\n   - Change reading mode to continuous\n   - Verify mode switches correctly\n   - Verify all pages load in continuous mode\n\n3. **Authentication Flow**\n   - Navigate to login page\n   - Enter credentials\n   - Submit form\n   - Verify redirect to library\n   - Verify session cookie set\n   - Navigate to protected page\n   - Verify access granted\n   - Click logout\n   - Verify redirect to login\n   - Attempt to access protected page\n   - Verify redirect to login\n\n4. **Navigation Flow**\n   - Click each main nav link (Library, Tags, Admin)\n   - Verify correct page loads\n   - Verify active nav item highlighted\n   - Test mobile hamburger menu\n   - Verify offcanvas opens\n   - Click mobile nav link\n   - Verify navigation works\n\n### End-to-End Testing\n\n**User Scenarios:**\n\n1. **Complete Reading Session**\n   - User logs in\n   - Browses library\n   - Searches for title\n   - Opens book\n   - Starts reading entry\n   - Reads multiple pages\n   - Closes reader\n   - Verifies progress saved\n   - Logs out\n\n2. **Theme Customization**\n   - User opens site\n   - System detects preferred theme\n   - User toggles theme multiple times\n   - User navigates across pages\n   - Theme preference persists\n   - User returns next day\n   - Theme preference still saved\n\n3. **Library Management**\n   - Admin logs in\n   - Navigates to admin page\n   - Initiates library scan\n   - Waits for scan completion\n   - Returns to library\n   - Verifies new titles appear\n   - Searches for new title\n   - Confirms it's accessible\n\n## Technology Stack\n\n### Test Framework\n- **Playwright** (latest): Browser automation and testing framework\n  - Supports Chromium, Firefox, WebKit\n  - Built-in test runner with parallel execution\n  - Screenshot and video capture\n  - Network interception\n  - Mobile viewport simulation\n\n### Language\n- **TypeScript 5.x**: Type-safe test code\n  - Better IDE support (autocomplete, refactoring)\n  - Catch errors at compile time\n  - Self-documenting code with types\n\n### Reporting\n- **Playwright HTML Reporter**: Visual test reports with screenshots\n- **Playwright JSON Reporter**: Machine-readable results for CI integration\n\n### Development Tools\n- **ESLint**: Code quality and style enforcement\n- **Prettier**: Code formatting\n- **ts-node**: Run TypeScript directly without compilation\n\n## File Structure\n\n```\ntests/\n├── playwright.config.ts          # Playwright configuration\n├── package.json                  # Node.js dependencies\n├── tsconfig.json                 # TypeScript configuration\n├── .eslintrc.json               # ESLint configuration\n├── integration/                  # Test suites\n│   ├── theme.spec.ts            # Theme toggle tests\n│   ├── reader.spec.ts           # Reader functionality tests\n│   ├── navigation.spec.ts       # Navigation tests\n│   ├── auth.spec.ts             # Authentication tests\n│   └── library.spec.ts          # Library search/sort tests\n├── helpers/                      # Reusable utilities\n│   ├── test-utils.ts            # General test helpers\n│   ├── page-objects.ts          # Page object models\n│   ├── fixtures.ts              # Test fixtures\n│   ├── assertions.ts            # Custom assertions\n│   └── server.ts                # Server start/stop utilities\n├── reports/                      # Test reports (gitignored)\n│   ├── index.html               # HTML test report\n│   └── results.json             # JSON test results\n└── screenshots/                  # Test evidence (gitignored)\n    ├── theme-toggle-before.png\n    └── theme-toggle-after.png\n```\n\n## CI/CD Integration\n\n### GitHub Actions Workflow\n\n```yaml\nname: Integration Tests\n\non: [pull_request, push]\n\njobs:\n  integration-tests:\n    runs-on: ubuntu-latest\n\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: Install Rust\n        uses: actions-rs/toolchain@v1\n        with:\n          toolchain: stable\n\n      - name: Install Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: '20'\n\n      - name: Install dependencies\n        run: |\n          npm install --prefix tests\n          npx playwright install --with-deps chromium\n\n      - name: Build CSS\n        run: ./build-css.sh\n\n      - name: Run integration tests\n        run: npm test --prefix tests\n\n      - name: Upload test results\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: playwright-report\n          path: tests/reports/\n\n      - name: Upload screenshots\n        if: failure()\n        uses: actions/upload-artifact@v4\n        with:\n          name: test-screenshots\n          path: tests/screenshots/\n```\n\n## Performance Considerations\n\n- **Parallel Test Execution**: Run independent tests in parallel (estimated 60% time reduction)\n- **Browser Reuse**: Share browser context between tests when possible\n- **Selective Screenshots**: Only capture screenshots on failure (reduce disk I/O)\n- **Headless Mode**: Run tests in headless browsers in CI (faster startup)\n- **Smart Retries**: Retry only flaky tests, not systematic failures\n- **Resource Cleanup**: Always close browsers and stop servers in teardown\n\n## Security Considerations\n\n- **Test Credentials**: Use dedicated test account, never production credentials\n- **Test Database**: Isolated test database, never connect to production\n- **Secrets Management**: Store test credentials in environment variables or CI secrets\n- **Port Isolation**: Use non-standard ports for test server to avoid conflicts\n\n## Maintenance and Scalability\n\n- **Page Object Updates**: When UI changes, update centralized page objects\n- **Test Modularity**: Add new tests by reusing existing helpers and fixtures\n- **Backward Compatibility**: Test utilities maintain stable interfaces\n- **Documentation**: Each test file includes JSDoc comments explaining purpose\n- **Regular Review**: Monthly review of flaky tests and execution times\n",
  "fileStats": {
    "size": 16678,
    "lines": 488,
    "lastModified": "2025-11-22T07:19:05.991Z"
  },
  "comments": []
}