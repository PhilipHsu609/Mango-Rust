{
  "id": "snapshot_1763797414339_0gpxmfvo5",
  "approvalId": "approval_1763797414333_w2apnaxmp",
  "approvalTitle": "Design: Theme Naming Refactor",
  "version": 1,
  "timestamp": "2025-11-22T07:43:34.339Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design implements a semantically correct, dual-class theme system for Mango-Rust. The refactoring converts the confusing backwards naming (`uk-light` for dark mode) to intuitive, modern conventions (`uk-dark` for dark mode, `uk-light` for light mode). Both themes will be explicitly defined with equal representation, improving code maintainability and developer experience.\n\nThe solution involves renaming CSS selectors, restructuring LESS files, and updating JavaScript theme management logic while maintaining backwards compatibility with existing user preferences.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n**N/A** - No steering documents exist for this project. Design follows established patterns found in codebase:\n- LESS-based CSS architecture with modular imports\n- Vanilla JavaScript for DOM manipulation (no framework dependencies)\n- localStorage for client-side persistence\n- UIkit CSS framework as foundation\n\n### Project Structure (structure.md)\n\n**Current Frontend Structure (following existing patterns):**\n```\nstatic/src/\n├── css/\n│   ├── _variables.less        # Design tokens (colors, spacing, typography)\n│   ├── _dark-theme.less        # Dark mode overrides (currently uses body.uk-light)\n│   ├── _uikit-light.less       # Light mode UIkit overrides\n│   ├── base.less               # Global layout and typography\n│   ├── main.less               # Entry point (import order)\n│   ├── components/             # Reusable UI components\n│   └── pages/                  # Page-specific styles\n└── js/\n    └── core.js                 # Theme management + localStorage helpers\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`_variables.less`**: Already defines both light and dark color tokens\n  - Light tokens: `@bg-light`, `@text-primary`, `@primary-color`, etc.\n  - Dark tokens: `@dark-bg`, `@dark-text-primary`, `@dark-border`, etc.\n  - **Reuse Strategy**: No changes needed, already supports dual themes\n\n- **`core.js` theme functions**: Existing API structure is sound\n  - `getTheme()`: Returns 'dark' or 'light'\n  - `applyTheme(theme)`: Applies theme class to body\n  - `toggleTheme()`: Switches between themes\n  - `detectSystemTheme()`: Respects prefers-color-scheme\n  - **Reuse Strategy**: Keep function signatures, update class names in implementation\n\n- **LESS build system**: Build pipeline already compiles LESS to CSS\n  - Build script: `./build-css.sh` (uses `lessc`)\n  - Entry point: `static/src/css/main.less`\n  - Output: `static/css/main.css`\n  - **Reuse Strategy**: No changes to build process, only source files\n\n### Integration Points\n\n- **Templates**: No changes required\n  - Templates already include compiled `main.css` and `core.js`\n  - Theme logic is entirely CSS class-based\n  - No server-side theme rendering\n\n- **localStorage**: Maintains existing schema\n  - Key: `'theme'`\n  - Values: `'dark'` or `'light'` (no change)\n  - Backwards compatible with existing user preferences\n\n## Architecture\n\nThe refactoring uses a **dual-class explicit theme system** where both light and dark modes are explicitly defined using CSS class selectors. This replaces the current asymmetric approach (dark = class, light = baseline).\n\n### Modular Design Principles\n\n- **Single File Responsibility**:\n  - `_light-theme.less`: ONLY light mode overrides (scope: `body.uk-light`)\n  - `_dark-theme.less`: ONLY dark mode overrides (scope: `body.uk-dark`)\n  - `_variables.less`: Theme-agnostic design tokens\n  - `core.js`: Theme state management (no business logic mixing)\n\n- **Component Isolation**:\n  - Theme files operate independently through CSS cascade\n  - No cross-dependencies between theme files\n  - Variables provide shared contract (DRY principle)\n\n- **Service Layer Separation**:\n  - JavaScript: Theme detection → selection → application (pure functions)\n  - CSS: Theme definition → scoped overrides (declarative)\n  - localStorage: Persistence layer (separated from logic)\n\n```mermaid\ngraph TD\n    A[User Action / System Preference] --> B[core.js: Theme Detection]\n    B --> C{getTheme / detectSystemTheme}\n    C --> D[applyTheme function]\n    D --> E{Theme Value}\n    E -->|'dark'| F[Add body.uk-dark class]\n    E -->|'light'| G[Add body.uk-light class]\n    F --> H[CSS: _dark-theme.less applies]\n    G --> I[CSS: _light-theme.less applies]\n    H --> J[User sees dark UI]\n    I --> K[User sees light UI]\n    D --> L[localStorage.setItem theme, value]\n\n    style F fill:#2a2a2a,color:#e5e5e5\n    style H fill:#2a2a2a,color:#e5e5e5\n    style J fill:#2a2a2a,color:#e5e5e5\n    style G fill:#fafafa,color:#333\n    style I fill:#fafafa,color:#333\n    style K fill:#fafafa,color:#333\n```\n\n### CSS Cascade Strategy\n\n**Import Order in `main.less`** (determines cascade priority):\n```less\n1. _variables.less       // Design tokens (no selectors)\n2. base.less             // Baseline/default styles\n3. _light-theme.less     // Light mode overrides (body.uk-light scope)\n4. components/_nav.less  // Component styles\n5. pages/*.less          // Page-specific styles\n6. _dark-theme.less      // Dark mode overrides (body.uk-dark scope) - LAST\n```\n\n**Rationale**:\n- Base styles provide fallback if neither theme class present\n- Light theme comes before dark theme in source order\n- Dark theme loads last, ensuring overrides work correctly\n- Component/page styles can be themed by both light and dark selectors\n\n## Components and Interfaces\n\n### Component 1: Theme State Manager (JavaScript)\n\n**File**: `static/src/js/core.js`\n\n**Purpose**: Detect, apply, and persist theme preferences\n\n**Interfaces**:\n```javascript\n// Public API (exposed globally)\ngetTheme(): string                    // Returns 'dark' | 'light'\napplyTheme(theme: string): void       // Applies theme class, saves to localStorage\ntoggleTheme(): void                   // Switches between themes\ndetectSystemTheme(): string           // Returns 'dark' | 'light' from system\n\n// Internal helpers\nfunction ensureSingleThemeClass()     // Removes opposite theme class before applying new\n```\n\n**Dependencies**:\n- Browser APIs: `localStorage`, `window.matchMedia`, `document.body.classList`\n- No external libraries\n\n**Reuses**: Existing function structure, localStorage key `'theme'`\n\n**Changes**:\n```javascript\n// OLD (current):\nif (theme === 'dark') {\n    document.body.classList.add('uk-light');\n} else {\n    document.body.classList.remove('uk-light');\n}\n\n// NEW (refactored):\n// Remove opposite theme class first\ndocument.body.classList.remove('uk-dark', 'uk-light');\n// Add correct theme class\nif (theme === 'dark') {\n    document.body.classList.add('uk-dark');\n} else {\n    document.body.classList.add('uk-light');\n}\n```\n\n### Component 2: Light Theme Styles (CSS/LESS)\n\n**File**: `static/src/css/_light-theme.less`\n\n**Purpose**: Define light mode appearance for all UI components\n\n**Interfaces**:\n- CSS selector scope: `body.uk-light { ... }`\n- Inherits from: `_variables.less` (light color tokens)\n\n**Dependencies**:\n- `@import '_variables'` (for `@bg-light`, `@text-primary`, etc.)\n\n**Reuses**: Content from current `_uikit-light.less` + baseline styles\n\n**Structure**:\n```less\nbody.uk-light {\n    color: @text-primary;\n    background: @bg-light;\n\n    // Navigation\n    .uk-navbar-container { background: @bg-white; }\n\n    // Forms\n    .uk-input { background: white; color: @text-primary; }\n\n    // Cards, modals, buttons, etc.\n    // ... (comprehensive light theme overrides)\n}\n```\n\n### Component 3: Dark Theme Styles (CSS/LESS)\n\n**File**: `static/src/css/_dark-theme.less`\n\n**Purpose**: Define dark mode appearance for all UI components\n\n**Interfaces**:\n- CSS selector scope: `body.uk-dark { ... }` (CHANGED from `body.uk-light`)\n- Inherits from: `_variables.less` (dark color tokens)\n\n**Dependencies**:\n- `@import '_variables'` (for `@dark-bg`, `@dark-text-primary`, etc.)\n\n**Reuses**: Existing file content (358 lines), only selector changes\n\n**Changes**: Single find-replace operation\n```less\n// OLD:\nbody.uk-light { ... }\n\n// NEW:\nbody.uk-dark { ... }\n```\n\n### Component 4: LESS Entry Point (Build Configuration)\n\n**File**: `static/src/css/main.less`\n\n**Purpose**: Import all LESS sources in correct cascade order\n\n**Interfaces**:\n- Build tool input (consumed by `lessc`)\n- Outputs: `static/css/main.css`\n\n**Dependencies**: All LESS partials\n\n**Changes**:\n```less\n// OLD:\n@import '_uikit-light';     // Line 13\n@import '_dark-theme';      // Line 25\n\n// NEW:\n@import '_light-theme';     // Line 13 (renamed file)\n@import '_dark-theme';      // Line 25 (no change)\n```\n\n## Data Models\n\n### Theme Preference Model (localStorage)\n\n**Schema**: Simple string value\n\n```typescript\n// localStorage key-value pair\n{\n  key: 'theme',\n  value: 'dark' | 'light' | null\n}\n\n// Runtime JavaScript representation\ninterface ThemeState {\n  saved: 'dark' | 'light' | null;     // From localStorage\n  system: 'dark' | 'light';            // From matchMedia\n  effective: 'dark' | 'light';         // Computed (saved ?? system)\n  class: 'uk-dark' | 'uk-light';       // Applied to body\n}\n```\n\n**Validation**:\n```javascript\nfunction isValidTheme(value) {\n    return value === 'dark' || value === 'light';\n}\n```\n\n### CSS Class State Model\n\n**Mutually Exclusive Classes**: Only ONE of these can be active at a time\n```\nbody.uk-dark     // Dark theme active\nbody.uk-light    // Light theme active\nbody             // Neither (fallback to base styles)\n```\n\n**State Transitions**:\n```\n[Load] → Check localStorage → Apply saved OR system preference\n[Toggle] → Remove current → Add opposite → Save to localStorage\n[System Change] → If no manual override → Apply system preference\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Scenario: localStorage unavailable (private browsing, quota exceeded)**\n   - **Handling**: Graceful degradation to system theme detection\n   - **Code**:\n     ```javascript\n     function saveTheme(theme) {\n         try {\n             localStorage.setItem('theme', theme);\n         } catch (e) {\n             console.warn('Theme preference not saved:', e.message);\n             // Continue with in-memory theme (still works for session)\n         }\n     }\n     ```\n   - **User Impact**: Theme preference lost on page reload (defaults to system)\n\n2. **Scenario: matchMedia API not supported (old browsers)**\n   - **Handling**: Default to light theme\n   - **Code**:\n     ```javascript\n     function detectSystemTheme() {\n         if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {\n             return 'dark';\n         }\n         return 'light';  // Safe default\n     }\n     ```\n   - **User Impact**: System preference ignored, defaults to light\n\n3. **Scenario: Invalid theme value in localStorage (corruption/tampering)**\n   - **Handling**: Validate and fallback to system detection\n   - **Code**:\n     ```javascript\n     function getTheme() {\n         const saved = localStorage.getItem('theme');\n         if (saved === 'dark' || saved === 'light') {\n             return saved;  // Valid\n         }\n         return detectSystemTheme();  // Invalid, use system\n     }\n     ```\n   - **User Impact**: Corrupted preference ignored, auto-detects theme\n\n4. **Scenario: FOUC (Flash of Unstyled Content) during page load**\n   - **Handling**: Apply theme class to `<html>` element before DOM ready\n   - **Code**:\n     ```javascript\n     // IIFE runs immediately (before DOMContentLoaded)\n     (function() {\n         const theme = getTheme();\n         const className = theme === 'dark' ? 'uk-dark' : 'uk-light';\n         document.documentElement.classList.add(className);\n     })();\n     ```\n   - **User Impact**: No flash, correct theme renders immediately\n\n## Testing Strategy\n\n### Unit Testing\n\n**JavaScript Functions** (can be tested in isolation):\n```javascript\n// Test suite structure (if testing framework added later)\ndescribe('Theme Management', () => {\n    test('detectSystemTheme returns dark when prefers-color-scheme is dark')\n    test('detectSystemTheme returns light when prefers-color-scheme is light')\n    test('getTheme returns localStorage value when valid')\n    test('getTheme returns detectSystemTheme when localStorage invalid')\n    test('applyTheme adds uk-dark class when theme is dark')\n    test('applyTheme adds uk-light class when theme is light')\n    test('applyTheme removes opposite class before applying new')\n    test('toggleTheme switches from dark to light')\n    test('toggleTheme switches from light to dark')\n});\n```\n\n**Manual Testing Checklist** (current approach):\n- [ ] Browser console: `getTheme()` returns correct value\n- [ ] Browser console: `applyTheme('dark')` adds `uk-dark` class\n- [ ] Browser console: `applyTheme('light')` adds `uk-light` class\n- [ ] Browser console: `toggleTheme()` switches classes correctly\n\n### Integration Testing\n\n**Theme Application Flow**:\n```javascript\n// Test scenarios (manual browser testing)\n1. Fresh user (no localStorage):\n   - Open in private/incognito window\n   - Verify system theme detected\n   - Verify correct class applied to body\n   - Verify localStorage set after detection\n\n2. Returning user (existing preference):\n   - Set localStorage.setItem('theme', 'dark')\n   - Reload page\n   - Verify dark theme loads (ignores system preference)\n\n3. Theme toggle:\n   - Click theme toggle button\n   - Verify class switches on body\n   - Verify localStorage updates\n   - Verify UI re-renders correctly\n\n4. System theme change:\n   - Clear localStorage\n   - Change OS theme (System Settings)\n   - Verify app follows system change\n```\n\n**CSS Theme Rendering**:\n```\nTest Matrix: Verify visual appearance for each theme\n\nComponents to test:\n- Navigation bar (background, text colors, hover states)\n- Cards (title-card, entry-card on library/book pages)\n- Forms (inputs, selects, checkboxes)\n- Modals (background, borders, text)\n- Buttons (default, primary variants)\n- Tables (headers, rows, hover states)\n- Alerts (warning, success backgrounds)\n\nFor each component:\n✓ Light theme: Matches light design tokens\n✓ Dark theme: Matches dark design tokens\n✓ No theme class: Has readable fallback\n```\n\n### End-to-End Testing\n\n**User Scenarios** (manual browser testing):\n\n1. **First-time visitor with dark system preference**:\n   - User has macOS/Windows dark mode enabled\n   - Opens Mango-Rust in browser\n   - Expected: Dark theme loads immediately, no flash\n   - Expected: `body` has `uk-dark` class\n   - Expected: localStorage has `theme: \"dark\"`\n\n2. **User manually switches to light theme**:\n   - User clicks theme toggle button/icon\n   - Expected: UI transitions to light theme smoothly\n   - Expected: `body` class changes from `uk-dark` to `uk-light`\n   - Expected: localStorage updates to `theme: \"light\"`\n   - User refreshes page\n   - Expected: Light theme persists (ignores dark system preference)\n\n3. **User clears browser data**:\n   - User clears localStorage via DevTools or browser settings\n   - User refreshes page\n   - Expected: System theme auto-detected again\n   - Expected: Correct theme class applied\n\n4. **Cross-page navigation**:\n   - User selects dark theme on home page\n   - User navigates to library page\n   - Expected: Dark theme persists across navigation\n   - User navigates to book page\n   - Expected: Dark theme still active\n   - User navigates to reader page\n   - Expected: Dark theme still active (reader may have custom styling)\n\n**Browser Compatibility Testing**:\n```\nTest in:\n- Chrome/Edge (Chromium) - Latest\n- Firefox - Latest\n- Safari - Latest (macOS/iOS)\n\nVerify:\n- Theme classes apply correctly\n- localStorage works\n- matchMedia API works (system theme detection)\n- CSS renders correctly (vendor prefixes not needed for modern features)\n```\n\n## Migration Strategy\n\n### Phase 1: Rename Dark Theme Selector\n- Update `_dark-theme.less`: Change `body.uk-light` to `body.uk-dark`\n- No functionality change yet (JavaScript still uses old class)\n\n### Phase 2: Create Light Theme File\n- Rename `_uikit-light.less` → `_light-theme.less`\n- Wrap all rules in `body.uk-light { ... }` scope\n- Expand to comprehensive light theme (mirror dark theme structure)\n\n### Phase 3: Update JavaScript\n- Update `core.js`: Change class names from `uk-light` (for dark) to `uk-dark`/`uk-light`\n- Implement mutual exclusion (remove opposite class before applying new)\n- Update FOUC prevention code\n\n### Phase 4: Update Build Configuration\n- Update `main.less`: Change import from `_uikit-light` to `_light-theme`\n- Verify import order (light before dark)\n\n### Phase 5: Test and Deploy\n- Build CSS: `./build-css.sh`\n- Manual testing per testing strategy\n- Verify no visual regressions\n\n## Backwards Compatibility\n\n**localStorage Migration**: None needed!\n- Existing localStorage schema unchanged\n- Values remain `'dark'` and `'light'` (strings)\n- JavaScript reads same values, just maps to different CSS classes\n\n**User Experience**: Seamless\n- Users with `theme: 'dark'` in localStorage → Still get dark theme\n- Users with `theme: 'light'` in localStorage → Still get light theme\n- Users with no preference → Still get system theme\n\n**No Breaking Changes**:\n- Templates not modified (no server-side changes)\n- HTML structure unchanged (no new elements)\n- localStorage API unchanged\n- Theme toggle behavior unchanged (user-facing)\n",
  "fileStats": {
    "size": 17313,
    "lines": 524,
    "lastModified": "2025-11-22T07:43:28.423Z"
  },
  "comments": []
}